

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Raw SQL Queries &mdash; Документация Entity Framework Core 1.0.0</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="Документация Entity Framework Core 1.0.0" href="../index.html"/>
        <link rel="up" title="Запрос данных" href="index.html"/>
        <link rel="next" title="How Query Works" href="overview.html"/>
        <link rel="prev" title="Отслеживать или не отслеживать" href="tracking.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Entity Framework Core
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Entity Framework Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Приступая к работе</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modeling/index.html">Создание модели</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Запрос данных</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic.html">Основные запросы</a></li>
<li class="toctree-l2"><a class="reference internal" href="related-data.html">Загрузка связанных данных</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-eval.html">Клиентская или серверная валидация</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracking.html">Отслеживать или не отслеживать</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Raw SQL Queries</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="overview.html">How Query Works</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../saving/index.html">Сохранение данных</a></li>
<li class="toctree-l1"><a class="reference internal" href="../efcore-vs-ef6/index.html">EF Core vs. EF6.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="../providers/index.html">Провайдеры баз данных</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Разное</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Entity Framework Core</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Запрос данных</a> &raquo;</li>
      
    <li>Raw SQL Queries</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition attention">
<p class="first admonition-title">Внимание</p>
<p class="last">Эта документация для EF Core. Для EF6.x и более ранних версий смотрите <a class="reference external" href="http://msdn.com/data/ef">http://msdn.com/data/ef</a>.</p>
</div>
<div class="section" id="raw-sql-queries">
<h1>Raw SQL Queries<a class="headerlink" href="#raw-sql-queries" title="Ссылка на этот заголовок">¶</a></h1>
<p>Entity Framework Core allows you to drop down to raw SQL queries when working with a relational database. This can be useful if the query you want to perform can&#8217;t be expressed using LINQ, or if using a LINQ query is resulting in inefficient SQL being sent to the database.</p>
<div class="contents local topic" id="id1">
<p class="topic-title first"><cite>В этой статье:</cite></p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id4">Ограничения</a></li>
<li><a class="reference internal" href="#basic-raw-sql-queries" id="id5">Basic raw SQL queries</a></li>
<li><a class="reference internal" href="#passing-parameters" id="id6">Passing parameters</a></li>
<li><a class="reference internal" href="#composing-with-linq" id="id7">Composing with LINQ</a><ul>
<li><a class="reference internal" href="#including-related-data" id="id8">Including related data</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Совет</p>
<p class="last">Вы можете посмотреть <a class="reference external" href="https://github.com/aspnet/EntityFramework.Docs/tree/master/samples/Querying">пример</a> этой статьи на GitHub.</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id4">Ограничения</a><a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h2>
<dl class="docutils">
<dt>There are a couple of limitations to be aware of when using raw SQL queries:</dt>
<dd><ul class="first last simple">
<li>SQL queries can only be used to return entity types that are part of your model. There is an enhancement on our backlog to <a class="reference external" href="https://github.com/aspnet/EntityFramework/issues/1862">enable returning ad-hoc types from raw SQL queries</a>.</li>
<li>The SQL query must return data for all properties of the entity type.</li>
<li>The column names in the result set must match the column names that properties are mapped to. Note this is different from EF6.x where property/column mapping was ignored for raw SQL queries and result set column names had to match the property names.</li>
<li>The SQL query cannot contain related data. However, in many cases you can compose on top of the query using the <code class="docutils literal"><span class="pre">Include</span></code> operator to return related data (see <a class="reference internal" href="#including-related-data">Including related data</a>).</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="basic-raw-sql-queries">
<h2><a class="toc-backref" href="#id5">Basic raw SQL queries</a><a class="headerlink" href="#basic-raw-sql-queries" title="Ссылка на этот заголовок">¶</a></h2>
<p>You can use the <cite>FromSql</cite> extension method to begin a LINQ query based on a raw SQL query.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM dbo.Blogs&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<p>Raw SQL queries can be used to execute a stored procedure.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;EXECUTE dbo.GetMostPopularBlogs&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="passing-parameters">
<h2><a class="toc-backref" href="#id6">Passing parameters</a><a class="headerlink" href="#passing-parameters" title="Ссылка на этот заголовок">¶</a></h2>
<p>As with any API that accepts SQL, it is important to parameterize any user input to protect against a SQL injection attack. You can include parameter place holders in the SQL query string and then supply parameter values as additional arguments. Any parameter values you supply will automatically be converted to a <code class="docutils literal"><span class="pre">DbParameter</span></code>.</p>
<p>The following example passes a single parameter to a stored procedure. While this may look like <code class="docutils literal"><span class="pre">String.Format</span></code> syntax, the supplied value is wrapped in a parameter and the generated parameter name inserted where the <code class="docutils literal"><span class="pre">{0}</span></code> placeholder was specified.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="s">&quot;johndoe&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;EXECUTE dbo.GetMostPopularBlogsForUser {0}&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<p>You can also construct a DbParameter and supply it as a parameter value. This allows you to use named parameters in the SQL query string</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SqlParameter</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="s">&quot;johndoe&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;EXECUTE dbo.GetMostPopularBlogsForUser @user&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="composing-with-linq">
<h2><a class="toc-backref" href="#id7">Composing with LINQ</a><a class="headerlink" href="#composing-with-linq" title="Ссылка на этот заголовок">¶</a></h2>
<p>If the SQL query can be composed on in the database, then you can compose on top of the initial raw SQL query using LINQ operators. SQL queries that can be composed on being with the <code class="docutils literal"><span class="pre">SELECT</span></code> keyword.</p>
<p>The following example uses a raw SQL query that selects from a Table-Valued Function (TVF) and then composes on it using LINQ to perform filtering and sorting.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">searchTerm</span> <span class="p">=</span> <span class="s">&quot;.NET&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM dbo.SearchBlogs {0}&quot;</span><span class="p">,</span> <span class="n">searchTerm</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">Rating</span> <span class="p">&gt;</span> <span class="m">3</span><span class="p">)</span>
    <span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">Rating</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="including-related-data">
<h3><a class="toc-backref" href="#id8">Including related data</a><a class="headerlink" href="#including-related-data" title="Ссылка на этот заголовок">¶</a></h3>
<p>Composing with LINQ operators can be used to include related data in the query.</p>
<div class="highlight-c#"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">searchTerm</span> <span class="p">=</span> <span class="s">&quot;.NET&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">blogs</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Blogs</span>
    <span class="p">.</span><span class="n">FromSql</span><span class="p">(</span><span class="s">&quot;SELECT * FROM dbo.SearchBlogs {0}&quot;</span><span class="p">,</span> <span class="n">searchTerm</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">Posts</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="overview.html" class="btn btn-neutral float-right" title="How Query Works" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tracking.html" class="btn btn-neutral" title="Отслеживать или не отслеживать" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 Microsoft.
      Обновлено: июл. 04, 2016.

    </p>
  </div> Документация лицензирована под <a href="https://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC 3.0</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/wedc.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>