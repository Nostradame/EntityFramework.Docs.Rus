

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Понимание сервисов EF &mdash; Документация Entity Framework Core 1.0.0</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="Документация Entity Framework Core 1.0.0" href="../../index.html"/>
        <link rel="up" title="Что внутри" href="index.html"/>
        <link rel="prev" title="Разработка провайдера базы данных" href="writing-a-provider.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Entity Framework Core
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Entity Framework Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Приступая к работе</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeling/index.html">Создание модели</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../querying/index.html">Запрос данных</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../saving/index.html">Сохранение данных</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../efcore-vs-ef6/index.html">EF Core vs. EF6.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../providers/index.html">Провайдеры баз данных</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Разное</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../connection-strings.html">Connection Strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging.html">Логгирование</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html">Тестирование InMemory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-dbcontext.html">Конфигурирование DbContext</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rc1-rc2-upgrade.html">Обновление RC1 до RC2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rc2-rtm-upgrade.html">Upgrading from RC2 to RTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/index.html">Command Line Reference</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Что внутри</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="writing-a-provider.html">Разработка провайдера базы данных</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Понимание сервисов EF</a><ul class="simple">
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Entity Framework Core</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Разное</a> &raquo;</li>
      
          <li><a href="index.html">Что внутри</a> &raquo;</li>
      
    <li>Понимание сервисов EF</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition attention">
<p class="first admonition-title">Внимание</p>
<p class="last">Эта документация для EF Core. Для EF6.x и более ранних версий смотрите <a class="reference external" href="http://msdn.com/data/ef">http://msdn.com/data/ef</a>.</p>
</div>
<div class="section" id="ef">
<h1>Понимание сервисов EF<a class="headerlink" href="#ef" title="Ссылка на этот заголовок">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first"><cite>В этой статье:</cite></p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id11">Термины</a></li>
<li><a class="reference internal" href="#id3" id="id12">Категории сервисов</a></li>
<li><a class="reference internal" href="#id4" id="id13">Жизненный цикл сервиса</a></li>
<li><a class="reference internal" href="#adddbcontext" id="id14">Как работает AddDbContext</a><ul>
<li><a class="reference internal" href="#id5" id="id15">Особые случаи</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dbcontext" id="id16">Внутренний провайдер сервиса в DbContext</a><ul>
<li><a class="reference internal" href="#id6" id="id17">Предоставление пользовательского внутреннего провайдера сервиса</a></li>
<li><a class="reference internal" href="#id7" id="id18">Кэширование провайдера сервиса</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id19">Требования к провайдерам сервисов</a></li>
<li><a class="reference internal" href="#id9" id="id20">Дополнительная информация</a></li>
</ul>
</div>
<p>Entity Framework работает как набор совместно действующих сервисов. Сервис - это многократно используемый компонент. Сервис, как правило, является реализацией интерфейса. Сервисы доступны для других сервисов при помощи <a class="reference external" href="https://wikipedia.org/wiki/Dependency_injection">внедрения зависимостей (DI)</a>, который реализуется в EF при помощи <a class="reference external" href="https://docs.asp.net/en/latest/fundamentals/dependency-injection.html">Microsoft.Extensions.DependencyInjection</a>.</p>
<p>В данной статье рассматриваются некоторые основополагающие принципы для понимания того, как EF использует сервисы и DI.</p>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id11">Термины</a><a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h2>
<dl class="docutils">
<dt><strong>Сервис</strong></dt>
<dd>Повторно используемый компонент. Сервис в .NET идентифицирован классом или интерфейсом.
По соглашению Entity Framework использует интерфейсы только для идентификации сервисов.</dd>
<dt><strong>Жизненный цикл сервиса</strong></dt>
<dd>Описание того, каким образом сервис сохраняет и удаляет данные во время многократного использования
одного и того же типа сервиса.</dd>
<dt><strong>Провайдер сервиса</strong></dt>
<dd>Механизм для хранения коллекции сервисов. Также известен как контейнер сервисов.</dd>
<dt><strong>Коллекция сервисов</strong></dt>
<dd>Механизм создания провайдера сервиса.</dd>
</dl>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id12">Категории сервисов</a><a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h2>
<p>Сервисы делятся на одну или более категорий.</p>
<dl class="docutils">
<dt><strong>Сервисы контекста</strong></dt>
<dd>Услуги, которые связаны с определенным экземпляром <code class="docutils literal"><span class="pre">DbContext</span></code>. Они
предоставляют функциональные возможности для работы с моделью пользователя и параметрами контекста.</dd>
<dt><strong>Сервисы провайдеров</strong></dt>
<dd>Провайдер-специфичные реализации сервисов. Например, SQLite использует
“сервисы провайдера” для настройки поведения SQL генераций, миграций
и файлового ввода-вывода.</dd>
<dt><strong>Сервисы стадии проектирования</strong></dt>
<dd>Сервисы, используемые в то время, когда разработчик создает приложение. Например,
команды EF используют сервисы на стадии проектирования для выполнения миграций и генерирования кода
(так же известные как скаффолдинг).</dd>
<dt><strong>Сервисы пользователя</strong></dt>
<dd>Пользователь может определять пользовательские сервисы для взаимодействия с EF. Они разрабатыватся в
коде приложения, а не в коде провайдера. Например, пользователь может предоставить
реализацию <code class="docutils literal"><span class="pre">IModelCustomizer</span></code> для управления тем, как создается модель.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Провайдера сервиса не следует путать с &#8220;сервисом провайдеров&#8221;.</p>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id13">Жизненный цикл сервиса</a><a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h2>
<p>Службы EF могут быть зарегистрированы с различными опциями жизненного цикла. Подходящий вариант зависит от того, как сервис используется и реализован.</p>
<dl class="docutils">
<dt><strong>Transient</strong></dt>
<dd>Жизненный цикл сервиса Transient создается каждый раз, когда он вводится в другие
сервисы Это изолирует каждый экземпляр сервиса. Например,
<code class="docutils literal"><span class="pre">MigrationsScaffolder</span></code> не должен многократно использоваться, поэтому он регистрируется как
<strong>Transient</strong>.</dd>
<dt><strong>Scoped</strong></dt>
<dd>Жизненный цикл сервиса Scoped создается для каждого экземпляра <code class="docutils literal"><span class="pre">DbContext</span></code>. Это
используется для изоляции экземпляра <code class="docutils literal"><span class="pre">DbContext</span></code>. Например, <code class="docutils literal"><span class="pre">StateManager</span></code>
добавляется как <strong>Scoped</strong>, потому что он должен отслеживать состояние сущности только для одного контекста.</dd>
<dt><strong>Singleton</strong></dt>
<dd>Сервис с жизненным циклом <strong>Singleton</strong> существует в единственном экземпляре для каждого провайдера сервиса и охватывает все
области. Каждый раз, когда вводится сервис, используется один и тот же экземпляр. Например,
<code class="docutils literal"><span class="pre">IModelCustomizer</span></code> это <strong>Singleton</strong>, потому что он является идемпотентным, что означает,
что каждый вызов <code class="docutils literal"><span class="pre">IModelCustomizer.Customize()</span></code> не меняет настройки.</dd>
</dl>
</div>
<div class="section" id="adddbcontext">
<h2><a class="toc-backref" href="#id14">Как работает AddDbContext</a><a class="headerlink" href="#adddbcontext" title="Ссылка на этот заголовок">¶</a></h2>
<p>EF предоставляет метод расширения <code class="docutils literal"><span class="pre">AddDbContext&lt;TContext&gt;()</span></code> для
добавления использования EF в коллекции сервисов. Этот метод добавляет в коллекцию сервисов следующее:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">TContext</span></code> как &#8220;scoped&#8221;</li>
<li><code class="docutils literal"><span class="pre">DbContextOptions</span></code> как &#8220;singleton&#8221;</li>
<li><code class="docutils literal"><span class="pre">DbContextOptionsFactory&lt;T&gt;</span></code> как &#8220;singleton&#8221;</li>
</ul>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">AddDbContext</span></code> не добавляет в коллекцию сервисов сервисы контекста, сервисы провайдера, сервисы времени разработки (за исключением случаев, описанных в разделе <a class="reference internal" href="#id5">Особые случаи</a>). Для этого DbContext строит свой собственный внутренний провайдер сервиса.</p>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id15">Особые случаи</a><a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p><code class="docutils literal"><span class="pre">AddDbContext</span></code> добавляет <code class="docutils literal"><span class="pre">DbContextOptionsFactory&lt;T&gt;</span></code> в коллекцию сервисов, вызываемых AddDbContext (которые используются для создания &#8220;внешнего&#8221; провайдера сервиса). <code class="docutils literal"><span class="pre">DbContextOptionsFactory&lt;T&gt;</span></code> выступает в качестве моста между внешним провайдером сервиса и внутренним провайдером сервиса в DbContext. Если у внешнего поставщика есть сервисы для <code class="docutils literal"><span class="pre">ILoggerFactory</span></code> или <code class="docutils literal"><span class="pre">IMemoryCache</span></code>, то они будут добавлены к внутреннему провайдеру сервиса.</p>
<p>Для таких распространенных сценариев есть реализованные соединения, так что пользователи могут легко настроить логгирование и кэширование памяти без необходимости предоставления специализированного внутреннего провайдера сервисов.</p>
</div>
</div>
<div class="section" id="dbcontext">
<h2><a class="toc-backref" href="#id16">Внутренний провайдер сервиса в DbContext</a><a class="headerlink" href="#dbcontext" title="Ссылка на этот заголовок">¶</a></h2>
<p>По умолчанию, <code class="docutils literal"><span class="pre">DbContext</span></code> использует внутренний провайдер сервиса, который в приложении <strong>отделен</strong> от всех других провайдеров сервисов. Этот внутренний провайдер сконструирован из экземпляра <code class="docutils literal"><span class="pre">DbContextOptions</span></code>. Такие методы, как <code class="docutils literal"><span class="pre">UseSqlServer()</span></code> расширяют конструирование, добавляя специализированные сервисы для своей системы баз данных.</p>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id17">Предоставление пользовательского внутреннего провайдера сервиса</a><a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h3>
<p>&#8216;&#8217; DbContextOptionsBuilder&#8217;&#8217; предоставляет API для передачи в DbContext пользовательского провайдера сервиса для внутреннего исользования в EF. Эти API называются <code class="docutils literal"><span class="pre">DbContextOptions.UseInternalServiceProvider(провайдер</span> <span class="pre">IServiceProvider)</span></code>.</p>
<p>Если предоставлен пользовательский провайдер сервиса, DbContext не будет использовать <code class="docutils literal"><span class="pre">DbContextOptions</span></code> для создания своего собственного внутреннего провайдера сервисов. В пользовательский провайдер уже должен быть добавлен провайдер сервиса.</p>
<p>Разработчики провайдера базы данных должны предоставить методы, такие как &#8220;AddEntityFrameworkSqlServer&#8221; или &#8220;AddEntityFrameworkSqlite&#8221; для упровщения процесса создания пользовательского контейнера сервисов.</p>
<div class="highlight-csharp"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceCollection</span><span class="p">()</span>
    <span class="p">.</span><span class="n">AddEntityFrameworkSqlServer</span><span class="p">()</span>
    <span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">MyCustomService</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">BuildServiceProvider</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbContextOptionsBuilder</span><span class="p">();</span>

<span class="n">options</span>
    <span class="p">.</span><span class="n">UseInternalServiceProvider</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    <span class="p">.</span><span class="n">UseSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="p">);</span>

<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbContext</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
<span class="p">{</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id18">Кэширование провайдера сервиса</a><a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p>EF кэширует эти внутренние провайдеры сервисов с ключом <code class="docutils literal"><span class="pre">IDbContextOptions</span></code>.
Это означает что провайдер сервисов создается только один раз для каждого уникального набора параметров.
Он используется повторно, когда DbContext создается при помощи набора параметров, которые уже были использованы во время существования приложения.</p>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id19">Требования к провайдерам сервисов</a><a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h2>
<p>Провайдеры баз данных EF должны регистрировать основные наборы сервисов. Эти необходимые сервисы определены как свойства <code class="docutils literal"><span class="pre">IDatabaseProviderServices</span></code>. Разработчики провайдеров могут нуждаться в реализации некоторых сервисов с нуля. В других есть частичная или полная реализация библиотек EF которые могут быть использоавны повторно.</p>
<p>Дополнительную информацию о требованиях к провайдерам сервисов смотрите в разделе <a class="reference internal" href="writing-a-provider.html"><span class="doc">Разработка провайдера базы данных</span></a>.</p>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id20">Дополнительная информация</a><a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h2>
<p>Для реализации DI, EF использует <a class="reference external" href="https://www.nuget.org/packages/Microsoft.Extensions.DependencyInjection/">библиотеку Microsoft.Extensions.DependencyInjection</a>. Документация по этой библиотеке <a class="reference external" href="https://docs.asp.net/en/latest/fundamentals/dependency-injection.html">доступна на docs.asp.net</a>.</p>
<p><a class="reference external" href="http://dotnet.github.io/api/System.IServiceProvider.html">&#8220;System.IServiceProvider&#8221;</a> определен в библиотеке базовых классов .NET.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="writing-a-provider.html" class="btn btn-neutral" title="Разработка провайдера базы данных" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 Microsoft.
      Обновлено: июл. 04, 2016.

    </p>
  </div> Документация лицензирована под <a href="https://creativecommons.org/licenses/by-nc/3.0/">CC BY-NC 3.0</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/wedc.js"></script>
      <script type="text/javascript" src="../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>